# JWT Security Plugin

This plugin (`jwt_security`) checks code and configuration for common JWT-related misconfigurations and usage issues.

## What it detects

- Missing authentication protection on endpoints
  - Detects HTTP route handlers that do not use the project's authentication middleware (e.g. `authenticateToken`) and flags endpoints that should be protected.
- Low-entropy or weak JWT secrets
  - Scans configuration files (e.g. `.env`) and code for JWT secret values that are short, predictable, or clearly not cryptographically strong.
- Direct, ad-hoc JWT verification usage
  - Flags locations where `jwt.verify()` (or equivalent) is used directly instead of a centralized AuthService or helper, encouraging a single location for verification and error handling.
- Incomplete JWT error handling
  - Detects code paths which call verification without handling common JWT exceptions (expired token, malformed token, not-before, etc.).

## Rationale
JWTs are powerful but can be misused in ways that reduce their security. This plugin helps find common pattern mistakes early so they can be centralized, hardened, and consistently handled.

## Configuration
Add plugin configuration under `plugins.jwt_security` in the scanner config YAML.

Supported keys:

- `enabled` (bool): Enable or disable the plugin.
- `auth_middleware_names` (list[str]): Additional function/variable names that should be recognised as authentication middleware (default: `['authenticateToken']`).
- `min_secret_length` (int): Minimum allowed length for JWT secrets before flagging (default: 32).
- `exclude_paths` (list[str]): Path substrings to skip during scanning (e.g. `['tests/', 'fixtures/']`).
- `allowlist_secrets` (list[str]): Secret values or keys that should be ignored by the plugin.

Example config:

```yaml
plugins:
  jwt_security:
    enabled: true
    auth_middleware_names:
      - 'authenticateToken'
    min_secret_length: 32
    exclude_paths:
      - 'tests/'
      - 'fixtures/'
    allowlist_secrets:
      - 'LOCAL_DEV_SECRET'
```

## False positives and mitigation
- Routes defined in third-party libraries or vendored code may be flagged â€” add their paths to `exclude_paths`.
- Test fixtures often include dummy tokens; add test directories to `exclude_paths` or add known dummy token names to `allowlist_secrets`.
- If your project uses a different middleware name, add it to `auth_middleware_names` so route checks recognise it.

## Remediation suggestions
- Protect endpoints with a single authentication middleware (e.g. `authenticateToken`) and avoid sprinkling `jwt.verify()` calls across handlers.
- Use strong, randomly-generated secrets stored in environment variables or a secrets manager and rotate them regularly.
- Centralize JWT handling in an AuthService class that encapsulates verify/issue logic and error handling.
- Handle common JWT exceptions explicitly and return appropriate status codes (401 for invalid/expired, 403 for forbidden, etc.).

## Output
Findings are emitted as `SecurityFinding` objects with these fields:
- `title`
- `severity` (LOW/MEDIUM/HIGH/CRITICAL)
- `file_path`
- `line_number`
- `description`
- `plugin_name` ("jwt_security")
- `recommendation` (string or structured dict)

Example finding JSON snippet:

```json
{
  "title": "Missing JWT Protection: POST /api/orders",
  "severity": "MEDIUM",
  "file_path": "routes/orders.js",
  "line_number": 42,
  "description": "Endpoint POST /api/orders is not protected by authentication middleware.",
  "plugin_name": "jwt_security",
  "recommendation": {
    "summary": "Add authentication middleware to protect this endpoint.",
    "steps": [
      "Import authenticateToken middleware",
      "Add middleware to the route: router.post('/api/orders', authenticateToken, handler)"
    ]
  }
}
```

## Extending
To add more JWT checks, implement logic in the plugin's `scan()` method and call `self.add_finding(...)` with structured data. Prefer AST-based checks for accuracy where practical.

## Notes
This plugin uses heuristics and simple static analysis; it may not catch every JWT issue nor be 100% accurate for all code patterns. Use configuration to tune coverage and reduce false positives.
