#!/usr/bin/env python3
"""
NutriHelp Security Scanner V2.0 - Main Entry Point
Modular security scanner main program
"""

import os
import sys
import argparse
import json
import logging
from pathlib import Path

# Add the current directory to the Python path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from core.scanner_engine import SecurityScannerEngine
from core.config_manager import ConfigManager


def setup_logging(verbose: bool = False):
    """Set up logging system"""
    level = logging.DEBUG if verbose else logging.INFO
    logging.basicConfig(
        level=level,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[logging.StreamHandler()]
    )


def main():
    """Main function"""
    parser = argparse.ArgumentParser(
        description='NutriHelp Security Scanner V2.0 - Modular security scanner',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
        Example usage:
        %(prog)s --target ../                    # Scan parent directory
        %(prog)s --target ../ --format json     # Output in JSON format
        %(prog)s --target ../ --output report.html --format html
        %(prog)s --config custom_config.yaml --target ../
                """
            )
    
    parser.add_argument('--target', '-t', required=True,
                       help='Target directory path')
    parser.add_argument('--config', '-c',
                       help='Configuration file path')
    parser.add_argument('--format', '-f', default='summary',
                       choices=['json', 'html', 'summary'],
                       help='Output format (default: summary)')
    parser.add_argument('--output', '-o',
                       help='Output file path (default: stdout)')
    parser.add_argument('--verbose', '-v', action='store_true',
                       help='Show verbose logs')
    parser.add_argument('--version', action='version', version='%(prog)s 2.0.0')
    
    args = parser.parse_args()

    # Set up logging
    setup_logging(args.verbose)
    logger = logging.getLogger("main")
    
    try:
        logger.info("Starting NutriHelp Security Scanner V2.0")

        # 1. Load configuration
        config_manager = ConfigManager(args.config)
        if not config_manager.validate_config():
            logger.error("Configuration validation failed")
            return 1

        # 2. Initialize scanner engine
        scanner_config = config_manager.get_scanner_config()
        engine = SecurityScannerEngine(scanner_config)

        # 3. Load plugins
        plugin_configs = config_manager.get_enabled_plugins()
        engine.load_plugins(plugin_configs)
        
        if engine.stats['plugins_loaded'] == 0:
            logger.warning("No plugins loaded! Scanner will not find any issues.")

        # 4. Execute scan
        logger.info(f"Scanning target: {args.target}")
        scan_results = engine.scan_target(args.target)

        # 5. Generate output
        output_content = format_output(scan_results, args.format, config_manager)

        # 6. Write output
        if args.output:
            write_output_file(output_content, args.output, args.format)
            logger.info(f"Results saved to: {args.output}")
        else:
            print(output_content)

        # 7. Set exit code
        critical_count = scan_results['summary']['by_severity'].get('CRITICAL', 0)
        if critical_count > 0:
            logger.warning(f"Found {critical_count} critical security issues!")
            return 1
        
        logger.info("Scan completed successfully")
        return 0
        
    except FileNotFoundError as e:
        logger.error(f"File not found: {e}")
        return 1
    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        if args.verbose:
            import traceback
            traceback.print_exc()
        return 1


def format_output(scan_results: dict, output_format: str, config_manager: ConfigManager) -> str:
    """Format output results"""
    if output_format == 'json':
        return json.dumps(scan_results, indent=2, ensure_ascii=False)
    
    elif output_format == 'html':
        return generate_html_report(scan_results, config_manager)
    
    elif output_format == 'summary':
        return generate_summary_report(scan_results)
    
    else:
        raise ValueError(f"Unsupported output format: {output_format}")


def generate_summary_report(scan_results: dict) -> str:
    """Generate summary report"""
    summary = scan_results['summary']
    findings = scan_results['findings']
    scan_info = scan_results['scan_info']
    
    lines = []
    lines.append("üîí NutriHelp Security Scanner V2.0 Results")
    lines.append("=" * 50)
    lines.append("")

    # Scan information
    lines.append(f"üìÅ Target: {scan_info['target_path']}")
    lines.append(f"‚è∞ Scan Time: {scan_info['timestamp']}")
    lines.append(f"üìä Files Scanned: {scan_info['stats']['files_scanned']}")
    lines.append(f"üîå Plugins Used: {scan_info['stats']['plugins_loaded']}")
    lines.append("")

    # Summary statistics
    lines.append("üìä Issues Found by Severity:")
    severity_colors = {
        'CRITICAL': 'üî¥',
        'HIGH': 'üü†', 
        'MEDIUM': 'üü°',
        'LOW': 'üü¢'
    }
    
    total_issues = summary['total']
    if total_issues == 0:
        lines.append("   ‚úÖ No security issues found!")
    else:
        for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW']:
            count = summary['by_severity'].get(severity, 0)
            if count > 0:
                color = severity_colors.get(severity, '‚ö™')
                lines.append(f"   {color} {severity}: {count}")
    
    lines.append("")
    lines.append(f"Total Issues: {total_issues}")

    # Plugin statistics
    if summary['by_plugin']:
        lines.append("")
        lines.append("üîå Issues by Plugin:")
        for plugin_name, count in summary['by_plugin'].items():
            lines.append(f"   ‚Ä¢ {plugin_name}: {count}")

    # Critical issues details
    critical_findings = [f for f in findings if f.get('severity') == 'CRITICAL']
    if critical_findings:
        lines.append("")
        lines.append("üö® CRITICAL ISSUES (Need immediate attention):")
        lines.append("-" * 40)
        
        for i, finding in enumerate(critical_findings[:5], 1):  # Only show the first 5
            lines.append(f"{i}. {finding['title']}")
            lines.append(f"   üìÅ File: {finding['file_path']}")
            if finding.get('line_number'):
                lines.append(f"   üìç Line: {finding['line_number']}")
            lines.append(f"   üìù {finding['description']}")
            lines.append("")
        
        if len(critical_findings) > 5:
            lines.append(f"   ... and {len(critical_findings) - 5} more critical issues")

    # High priority issues overview
    high_findings = [f for f in findings if f.get('severity') == 'HIGH']
    if high_findings and len(high_findings) <= 3:  # Only show when high priority issues are few
        lines.append("")
        lines.append("üî∂ HIGH PRIORITY ISSUES:")
        lines.append("-" * 30)
        
        for finding in high_findings:
            lines.append(f"‚Ä¢ {finding['title']} ({finding['file_path']})")
    
    lines.append("")
    lines.append("üí° Use --format html for detailed visual report")
    lines.append("üí° Use --format json for machine-readable output")
    
    return '\n'.join(lines)


def generate_html_report(scan_results: dict, config_manager: ConfigManager) -> str:
    """Generate HTML report"""
    summary = scan_results['summary']
    findings = scan_results['findings']
    scan_info = scan_results['scan_info']
    
    html_template = """
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>NutriHelp Security Scanner V2.0 Report</title>
        <style>
            * {{ margin: 0; padding: 0; box-sizing: border-box; }}
            body {{ 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                margin: 20px; background: #f5f5f5; line-height: 1.6;
            }}
            .container {{ 
                max-width: 1200px; margin: 0 auto; background: white; 
                border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;
            }}
            .header {{ 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; padding: 30px; text-align: center;
            }}
            .header h1 {{ font-size: 2.5rem; margin-bottom: 10px; }}
            .header .meta {{ opacity: 0.9; font-size: 1.1rem; }}
            
            .summary {{ 
                padding: 30px; background: #f8f9fa; 
                display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                gap: 20px; border-bottom: 2px solid #e9ecef;
            }}
            .summary-card {{ 
                background: white; padding: 25px; border-radius: 10px; text-align: center; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid;
            }}
            .summary-card.critical {{ border-left-color: #dc3545; }}
            .summary-card.high {{ border-left-color: #fd7e14; }}
            .summary-card.medium {{ border-left-color: #ffc107; }}
            .summary-card.low {{ border-left-color: #28a745; }}
            .summary-card h3 {{ font-size: 2rem; margin-bottom: 10px; }}
            .summary-card p {{ color: #6c757d; font-weight: 500; }}
            
            .content {{ padding: 30px; }}
            .section-title {{ 
                font-size: 1.8rem; color: #2c3e50; margin: 30px 0 20px 0; 
                border-bottom: 2px solid #3498db; padding-bottom: 10px;
            }}
            
            .finding {{ 
                margin: 20px 0; padding: 25px; border: 1px solid #dee2e6; 
                border-radius: 10px; transition: transform 0.2s ease;
            }}
            .finding:hover {{ transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }}
            .finding.critical {{ border-left: 5px solid #dc3545; background: #fdf2f2; }}
            .finding.high {{ border-left: 5px solid #fd7e14; background: #fef8f3; }}
            .finding.medium {{ border-left: 5px solid #ffc107; background: #fffdf0; }}
            .finding.low {{ border-left: 5px solid #28a745; background: #f0f9f0; }}
            
            .finding-header {{ display: flex; justify-content: between; align-items: center; margin-bottom: 15px; }}
            .finding-title {{ font-size: 1.3rem; font-weight: bold; color: #2c3e50; }}
            .severity {{ 
                display: inline-block; padding: 6px 12px; border-radius: 20px; 
                font-size: 0.8rem; font-weight: bold; text-transform: uppercase;
            }}
            .severity.critical {{ background: #dc3545; color: white; }}
            .severity.high {{ background: #fd7e14; color: white; }}
            .severity.medium {{ background: #ffc107; color: black; }}
            .severity.low {{ background: #28a745; color: white; }}
            
            .file-info {{ 
                background: #f8f9fa; padding: 10px 15px; border-radius: 6px; 
                font-family: 'Courier New', monospace; font-size: 0.9rem; margin: 10px 0;
            }}
            .description {{ color: #495057; margin: 15px 0; }}
            .recommendation {{ 
                background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; 
                border-radius: 4px; margin-top: 15px;
            }}
            .recommendation strong {{ color: #1976d2; }}
            
            .no-issues {{ 
                text-align: center; padding: 60px; color: #28a745; 
                background: #f0f9f0; border-radius: 10px; margin: 20px 0;
            }}
            .no-issues h2 {{ font-size: 2rem; margin-bottom: 10px; }}
            
            .footer {{ 
                background: #2c3e50; color: white; text-align: center; 
                padding: 20px; margin-top: 30px;
            }}
            .footer a {{ color: #3498db; text-decoration: none; }}
            .footer a:hover {{ text-decoration: underline; }}
            
            .stats {{ 
                background: #e8f4fd; padding: 20px; border-radius: 8px; 
                margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                gap: 15px;
            }}
            .stat-item {{ text-align: center; }}
            .stat-number {{ font-size: 1.5rem; font-weight: bold; color: #2c3e50; }}
            .stat-label {{ color: #6c757d; font-size: 0.9rem; }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üîí NutriHelp Security Scanner V2.0</h1>
                <div class="meta">
                    <p><strong>Scan time:</strong> {timestamp}</p>
                    <p><strong>Target path:</strong> {target_path}</p>
                    <p><strong>Scanner version:</strong> {scanner_version}</p>
                </div>
            </div>
            
            <div class="summary">
                <div class="summary-card critical">
                    <h3>{critical_count}</h3>
                    <p>Critical Issues</p>
                </div>
                <div class="summary-card high">
                    <h3>{high_count}</h3>
                    <p>High Severity</p>
                </div>
                <div class="summary-card medium">
                    <h3>{medium_count}</h3>
                    <p>Medium Severity</p>
                </div>
                <div class="summary-card low">
                    <h3>{low_count}</h3>
                    <p>Low Severity</p>
                </div>
            </div>
            
            <div class="content">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number">{files_scanned}</div>
                        <div class="stat-label">Files Scanned</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{plugins_used}</div>
                        <div class="stat-label">Plugins Used</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{total_findings}</div>
                        <div class="stat-label">Total Issues</div>
                    </div>
                </div>
                
                {findings_html}
            </div>
            
            <div class="footer">
                <p>Generated by <strong>NutriHelp Security Scanner V2.0</strong></p>
                <p>For support, visit our documentation or contact the development team</p>
            </div>
        </div>
    </body>
    </html>
    """
    
    # Generate HTML for discovery
    if not findings:
        findings_html = '<div class="no-issues"><h2>‚úÖ No Security Issues Found!</h2><p>Your codebase has passed all security checks.</p></div>'
    else:
        findings_html = '<h2 class="section-title">üîç Detailed Findings</h2>'

        # Sort by severity
        sorted_findings = sorted(findings, key=lambda x: {
            'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3
        }.get(x.get('severity', 'MEDIUM'), 2))
        
        for finding in sorted_findings:
            severity = finding.get('severity', 'MEDIUM').lower()
            recommendation = finding.get('recommendation', 'Please review this security issue and take appropriate remediation steps.')
            
            finding_html = f"""
            <div class="finding {severity}">
                <div class="finding-header">
                    <div class="finding-title">{finding['title']}</div>
                    <span class="severity {severity}">{finding['severity']}</span>
                </div>
                
                <div class="file-info">
                    üìÅ {finding['file_path']}
                    {f" (Line {finding['line_number']})" if finding.get('line_number') else ''}
                </div>
                
                <div class="description">{finding['description']}</div>
                
                <div class="recommendation">
                    <strong>üí° Recommendation:</strong> {recommendation}
                </div>
                
                {f"<div style='margin-top: 10px; font-size: 0.9rem; color: #6c757d;'>Plugin: {finding['plugin']}</div>" if finding.get('plugin') else ''}
            </div>
            """
            findings_html += finding_html

    # Format timestamp
    from datetime import datetime
    try:
        timestamp_obj = datetime.fromisoformat(scan_info['timestamp'].replace('Z', '+00:00'))
        formatted_timestamp = timestamp_obj.strftime('%Y-%m-%d %H:%M:%S')
    except:
        formatted_timestamp = scan_info['timestamp']
    
    return html_template.format(
        timestamp=formatted_timestamp,
        target_path=scan_info['target_path'],
        scanner_version=scan_info['scanner_version'],
        critical_count=summary['by_severity'].get('CRITICAL', 0),
        high_count=summary['by_severity'].get('HIGH', 0),
        medium_count=summary['by_severity'].get('MEDIUM', 0),
        low_count=summary['by_severity'].get('LOW', 0),
        files_scanned=scan_info['stats']['files_scanned'],
        plugins_used=scan_info['stats']['plugins_loaded'],
        total_findings=summary['total'],
        findings_html=findings_html
    )


def write_output_file(content: str, file_path: str, output_format: str):
    """Write output file"""
    # Ensure output directory exists
    output_dir = os.path.dirname(file_path)
    if output_dir and not os.path.exists(output_dir):
        os.makedirs(output_dir)

    # Determine encoding
    encoding = 'utf-8'
    
    with open(file_path, 'w', encoding=encoding) as f:
        f.write(content)


if __name__ == '__main__':
    sys.exit(main())