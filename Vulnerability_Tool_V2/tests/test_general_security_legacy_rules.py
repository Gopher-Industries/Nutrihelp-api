import os
import sys
# ensure project package path is available for imports when running tests from repo root
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from plugins.general_security import GeneralSecurityPlugin


def test_legacy_api_key_rule_triggers(tmp_path):
    # create a sample JS file with hardcoded api_key
    sample = tmp_path / "sample_api_key.js"
    sample.write_text("const api_key = 'ABCDEFGH12345678';\nconsole.log('ok');\n")

    plugin = GeneralSecurityPlugin(config={})
    findings = plugin.scan(str(tmp_path))

    # There should be at least one finding whose title includes API_Key or Hardcoded
    titles = [f.title for f in plugin.findings]
    assert any('API_Key' in t or 'Hardcoded' in t or 'API Key' in t for t in titles), f"No api key finding found: {titles}"


def test_permissive_cors_triggers(tmp_path):
    sample = tmp_path / "cors.conf"
    sample.write_text("Access-Control-Allow-Origin: *\n")

    plugin = GeneralSecurityPlugin(config={})
    findings = plugin.scan(str(tmp_path))

    titles = [f.title for f in plugin.findings]
    assert any('Permissive CORS' in t or 'CORS' in t for t in titles), f"No CORS finding found: {titles}"
