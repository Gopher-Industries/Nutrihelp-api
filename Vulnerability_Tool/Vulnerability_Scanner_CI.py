import os
import re
import sys

# Define Vulnerability Patterns for JavaScript files
V_Patterns = {
    "Sql_Injection": re.compile(r'\.query\s*\(.*\+.*\)'),
    "XSS": re.compile(r'res\.send\s*\(.*\+.*\)'),
    "Command_Injection": re.compile(r'exec\s*\(.*\+.*\)'),
    "insecure_file_handling": re.compile(r'fs\.unlink\s*\(.*\)'),
    "insecure_file_upload": re.compile(r'multer\s*\(\s*{.*dest.*}\s*\)'),
    "Eval_Function": re.compile(r'eval\s*\(.*\)'),
    "Directory_Movement": re.compile(r'fs\.readFile\s*\(.*\.\.\/.*\)'),
    "Insecure_Token_Generation": re.compile(r'Math\.random\s*\(\)'),
    "Dangerous_Permission_Level": re.compile(r'fs\.chmod\s*\(.*\)'),
    "Redirects": re.compile(r'res\.redirect\s*\(.*req\.query\..*\)'),
    "API_Key_Hardcoded": re.compile(r'api_key\s*=\s*[\'"].*[\'"]'),
    "Weak_Hashing_Algorithm": re.compile(r'(md5|sha1|des)\s*\('),
    "Planetext_Credentials": re.compile(r'(username|password)\s*=\s*[\'"].*[\'"]'),
    "Insecure_SSL_Config": re.compile(r'server\.listen\s*\(.*http.*\)'),
    "HTTP_Called": re.compile(r'http\.get\s*\(.*\)'),
    "Sensitive_Data_Logging": re.compile(r'console\.(log|debug|error|warn)\s*\(.*(password|secret|key|token).*\)'),
    "JSON_Parsing_No_Validation": re.compile(r'JSON\.parse\s*\(.*req\.(body|query|params).*\)'),
    "Environment_Variables_In_Planetext": re.compile(r'process\.env\.[a-zA-Z_][a-zA-Z0-9_]*\s*=\s*[\'"].+[\'"]'),
    "Debug_Left_Exposed": re.compile(r'app\.get\s*\([\'"].*debug.*[\'"],.*\)'),
    "Insecure_File_Paths": re.compile(r'(fs\.(readFile|writeFile))\s*\(.*req\.(body|query|params)\.path.*\)'),
    "Unsecured_Spawn": re.compile(r'spawn\s*\(.*\)'),
}

# Analyze File for Vulnerabilities (Only for .js files)
def AnalyseFile(FileLocation):
    vulnerabilities = {key: [] for key in V_Patterns.keys()}

    try:
        with open(FileLocation, 'r', encoding='utf-8') as file:
            Data = file.read()
    except Exception as e:
        return f"Error reading file {FileLocation}: {e}", None

    for key, pattern in V_Patterns.items():
        matches = pattern.findall(Data)
        if matches:
            vulnerabilities[key].extend(matches)

    return None, vulnerabilities

# Get the list of modified (pushed) files from GitHub Actions environment
def get_modified_files():
    return os.getenv("MODIFIED_FILES", "").split()

# Print Results in a Box
def PrintOutcome(Data):
    Outside = max(len(line) for line in Data.splitlines()) + 4
    box = '|' + '-' * (Outside - 2) + '|\n'
    for line in Data.splitlines():
        box += f"| {line.ljust(Outside - 4)} |\n"
    box += '|' + '-' * (Outside - 2) + '|'
    return box

# Main Execution
def main():
    modified_files = get_modified_files()

    if not modified_files or modified_files == ['']:
        print("No modified files detected.")
        return

    final_report = ""

    for file in modified_files:
        if not os.path.exists(file):
            final_report += f"File not found: {file}\n"
            continue

        final_report += f"\nDetected new file: {file}\n"

        # Check file type
        if file.endswith(".js"):
            final_report += f"Scanning {file} for vulnerabilities...\n"
            error, vulnerabilities = AnalyseFile(file)

            if error:
                final_report += f"{error}\n"
                continue

            if vulnerabilities and any(vulnerabilities.values()):
                Outcome = f"Potential Vulnerability Found in {file}:\n"
                for key, found in vulnerabilities.items():
                    if found:
                        Outcome += f"  {key.replace('_', ' ').title()}:\n"
                        for q in found:
                            Outcome += f"    - {q}\n"
            else:
                Outcome = f"No vulnerabilities found in {file}."

            final_report += PrintOutcome(Outcome) + "\n"

        else:
            final_report += f"{file} is not a JavaScript file. Skipping...\n"

    # Save to artifact log file
    with open("security_scan_report.txt", "w", encoding="utf-8") as report_file:
        report_file.write(final_report)

    # Also print it
    print(final_report)

if __name__ == "__main__":
    main()